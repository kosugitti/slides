---
title: "生成AIをつかったデータハンドリング"
subtitle: "& マルチエージェント・オーケストレーション実践報告"
author:
  - name: "Koji Kosugi"
    degrees: PhD
    url: "https://kosugitti.github.io/kosugitti10/"
    affiliations: Senshu University
    email: kosugitti_at_gmail.com
format:
    revealjs:
        theme: serif
        footer: "生成AI & Multi-Agent Orchestration"
        height: 1200
        width:  1600
        transition: slide
        slide-number: true
editor:
    render-on-save: true
from: markdown+emoji
---

# Part 1: 生成AIの基礎 {background-color="#2d4059"}

## ３大生成AI

- **ChatGPT** … Open AI社が作っている生成AIの先駆け。スムーズな会話が得意。

- **Gemini** … Google社が作っている生成AI。画像生成などは結構得意。大量の資料を読み込んでまとめるnotebookLMは教育シーンで便利。成長著しい。

- **Claude** … Anthropic社の生成AIで，プログラミングが得意なので，私はよく使います。

## ３大生成AIの使い方

- **会話モード** … アプリやブラウザを通じて生成AIとやりとりする。ChatGPTと楽しく会話するとかならコレ。プログラミングなどもできるけど，コピペするのが面倒

- **Copilotモード** … プログラミング中に「こう書きたいんでしょ？」を勝手に補ってくれるモード。

- **Agentモード** … 対話しながら，作業もさせる。優秀な部下ができるイメージ。プロジェクトの指示・方針が定まっていることが肝要。

## ３大窓口

- ブラウザ経由で使う
- 専用アプリ経由で使う
- CLI（Command Line Interface）
    - 最近は専用アプリでもローカルフォルダと連携して作業できたりするので，明確な区別は難しい
    - 今日はCLIの使い方を実演します

## CLIを使うツール

- **VSCode** … Microsoft社のエディタ。歴史もあるし毎月のアップデート，拡張機能も豊富。シンプルで一番おすすめ。フリーソフトウェア。

- **Cursor** … 生成AIと一緒にプログラミングする（Copilot, Agent）前提で作られている，VSCodeをベースにしたもの。複数のAIモデルを切り替えたりできる。有償。

- **Antigravity** … Google社が最近提供したエディタ。ブラウザと連携して操作できるので，スクレイピングなどをメインにする場合はこれがいい。

## Caution!

- 生成AIに学習させて良いかどうか，確認しましょう。
    - デフォルトでは入力したものがメーカーに見られています（学習のタネにされる）。オプションで「学習させない」ことができます。
    - 守秘義務があるもの，個人情報などは入力しないように。

- 計算はさせないほうがベター
    - 自分で数えたり計算したりするのは苦手（ハルシネーションを起こす）
    - コードを書いて実行するのが得意なので，計算方法を指示し，スクリプトに書かせる，結果を読ませる，という使い方

## どんな仕事やらせるの

- なんでも。思いつく限り色々やらせましょう
    - 研究費の使い方ルール.pdfみたいなのを読ませて，「これは消耗品でおちる？」とか聞く。領収書フォルダを読ませて，ファイル名に日付のprefixをつけろ，といった作業も
    - 学会の会報など，定期的に同じことを書く場合，過去の記事を読ませて「今年はXXとXXXに変わったのを踏まえて，草稿を書け」
    - 冒頭で「ログをとりながら作業しろ」，といい，「最後にログを見ながらマニュアルを作れ」という。事務作業の引き継ぎに

# Part 2: マルチエージェント実践報告 {background-color="#2d4059"}

## インスピレーション: multi-agent-shogun

[github.com/yohey-w/multi-agent-shogun](https://github.com/yohey-w/multi-agent-shogun)

- Claude Code の複数インスタンスを tmux で並列稼働させるシステム
- 封建制度の比喩: **将軍 → 家老 → 足軽**（最大8並列）
- ファイル（YAML）経由の通信，イベント駆動（inotifywait）

. . .

→ これを見て「自分のプロジェクトにも使いたい」と思った

→ 原稿執筆の要件に合わせて，**オーケストラの比喩で再設計**した

## なぜ自分で作ったのか

- Claude には Opus 4.6 から**公式のエージェントシステム**（subagent）がある
- しかし公式版は**バックグラウンドで動く** → 何をしているか見えない

. . .

::: {.callout-warning}
**原稿執筆には文章の責任が伴う。**
AIが裏で何を書き換えたかわからない状態は許容できない。
:::

. . .

→ すべての作業を**目の前で確認・承認**できるシステムを自作した

## 単体エージェントの限界

- Claude Code 1体でも十分に作業はできる
- しかしプロジェクトが大きくなると…
    - **コンテキストの消費**: 校閲・研究課題・ビルドを1セッションでやるとすぐ上限に
    - **専門性の分散**: 「表記統一」と「文章の推敲」では見るべきポイントが違う
    - **直列処理**: 1体では同時に1つの仕事しかできない

. . .

→ 複数のエージェントに**分業**させたい

## Claude Code とは

- Anthropic社が提供する**ターミナルで動くAIエージェント**
- ファイルの読み書き，コマンド実行，Git操作などを自律的に行う
- `CLAUDE.md` にプロジェクトのルールを書いておくと，それに従って作業する
- `--system-prompt` オプションで**人格・役割・行動規範**を注入できる

```bash
# 基本的な起動
claude

# カスタムプロンプト付きで起動
claude --system-prompt "$(cat agent1.md)"
```

## tmux とは

- ターミナルの**画面分割・セッション管理**ツール
- 1つのターミナルで複数の作業領域（ペイン）を同時に表示できる
- セッションを維持したまま切り離し・再接続が可能

. . .

**今回の使い方:**

- 3つのペインで3体のエージェントを同時稼働
- 1つのペインでファイル監視（ダッシュボード）
- 別ウィンドウでバンマス（指揮用）

## システム全体像: オーケストラの比喩

:::: {.columns}
::: {.column width="50%"}

| 役割 | 対応 |
|------|------|
| 指揮者 | ユーザー（あなた） |
| バンマス | 取次役エージェント |
| 奏者 | ワーカーエージェント |
| ステージマネージャー | watcher.sh |

:::

::: {.column width="50%"}

| Agent | 愛称 | 担当 |
|-------|------|------|
| Agent1 | ビオラ | 研究課題・参考文献 |
| Agent2 | チェロ | 校正・推敲 |
| Agent3 | コントラバス | 表記統一・ビルド |

:::
::::

. . .

ユーザーは**バンマスにだけ**話しかける。バンマスが適切なエージェントに振り分ける。

## 最大の制約: CLI同士は直接通信できない

::: {.callout-important}
**Claude Code の CLI インスタンスは，別の CLI の画面に直接出力できない。**
:::

. . .

ではどうするか？

. . .

→ **ファイルを通信路にする**

## 設計原則: ファイルが通信路

```
agents/queue/
├── agent1/
│   ├── task.md      ← バンマスが書く（指示）
│   └── report.md    ← エージェントが書く（報告）
├── agent2/
│   ├── task.md
│   └── report.md
└── agent3/
    ├── task.md
    └── report.md
```

- **ファイルが内容を運ぶ**: 長文でも構造化データでも壊れない
- **tmux は最小限のトリガーだけ**: 送るのは `"check"` の1単語のみ
- **watcher.sh がイベント駆動を担う**: ファイル変更を検知して通知

## 通信の流れ: 指示

```
[ユーザー]  「第7章の校閲をお願い」
    ↓
[バンマス]  キーワード「校閲」→ Agent2 に振り分け
    ↓  Bash: cat > queue/agent2/task.md
[task.md]  status: pending, 指示内容を書き込み
    ↓  (mtime 変化)
[watcher.sh]  変化を検知！
    ↓  tmux send-keys "check"
[Agent2]  task.md を読んで作業開始
```

## 通信の流れ: 報告

```
[Agent2]  校閲完了！
    ↓  Bash: cat > queue/agent2/report.md
[report.md]  status: needs_approval, 修正提案を記載
    ↓  (mtime 変化)
[watcher.sh]  変化を検知！
    ↓  tmux send-keys "check"
[バンマス]  report.md を読んでユーザーに報告
    ↓
[ユーザー]  「承認」
    ↓
[バンマス]  task.md を status: approved で更新
    ↓  (watcher が再検知 → Agent2 に "check")
[Agent2]  承認を確認 → 修正を実行
```

## 安全弁: 二重の防御

**1. システムプロンプトによる行動制御**

- エージェントは必ず**報告 → 承認 → 実行**のフローに従う
- 「勝手にファイルを書き換えない」をプロンプトに明記

. . .

**2. Git ブランチによる隔離**

```
main (安定版)
  ├── agent1/xxx  ← Agent1 の作業ブランチ
  └── agent2/xxx  ← Agent2 の作業ブランチ
```

- 万一の誤編集も `git checkout` で即復元可能
- Agent3 がコンパイル前にマージ，コンフリクトは報告

## 画面構成

```
iTerm2 ウィンドウ1: エージェント画面
┌──────────┬──────────┬──────────┐
│ Agent1   │ Agent2   │ Agent3   │
│ ビオラ    │ チェロ    │コントラバス│
│ 研究課題  │ 校閲     │ ビルド    │
├──────────┴──────────┴──────────┤
│ Watcher Dashboard              │
│ [!] チェロ: 承認待ち 16:05     │
│ [>] ビオラ: 作業中             │
└────────────────────────────────┘

iTerm2 ウィンドウ2: バンマス（ここに指示を打つ）
┌────────────────────────────────┐
│ > チェロから報告が参りました     │
│   承認しますか?                 │
└────────────────────────────────┘
```

## 起動はワンコマンド

```bash
bash agents/launch.sh
```

これだけで以下が自動実行される:

1. 通信用ディレクトリ（queue/）の初期化
2. tmux セッション作成（2ウィンドウ）
3. エージェント3体の起動（各自のシステムプロンプト付き）
4. watcher.sh の起動
5. バンマスの起動
6. iTerm2 で2ウィンドウ表示

## 設計の進化: 1日で4回やり直した

| ver | 方式 | 問題点 |
|-----|------|--------|
| v1 | tmux send-keys で長文送信 | 補完メニューに吸われる，不安定 |
| v2 | 画面マーカー + 信号ファイル二重報告 | 二重管理の不整合，デッドロック |
| v3 | ファイルキュー + watcher | 安定！ただし権限プロンプトが問題 |
| **v3.1** | **skip-permissions + Git ブランチ** | **現行版。安定稼働中** |

. . .

→ **Claude Code の CLI 同士が直接通信できない**制約を乗り越えるまでの試行錯誤

## 実プロジェクトでの成果

**AdvansedPsyStat**（放送大学大学院テキスト，全15章・17万字）の制作に投入

- **Agent1（ビオラ）**: 研究課題45問の作成，参考文献の整備
- **Agent2（チェロ）**: 全15章の校正・推敲（表記統一，誤字脱字，読みやすさ改善）
- **Agent3（コントラバス）**: LaTeX表記ルールの機械的チェック，コンパイル・コミット

. . .

→ 3体が**並行して**別々の章を作業できるので，1体でやるより圧倒的に速い

## 配布セット（最小構成）

```
agents/
├── ARCHITECTURE.md   # 設計思想（これが一番大事）
├── launch.sh         # 起動スクリプト
├── stop.sh           # 終了スクリプト
├── watcher.sh        # ファイル監視デーモン
├── bandmaster.md     # バンマスのプロンプト（要カスタマイズ）
├── agent1.md         # エージェント1（要カスタマイズ）
├── agent2.md         # エージェント2（要カスタマイズ）
└── agent3.md         # エージェント3（要カスタマイズ）
```

## 試してみるには

**必要なもの:**

- Claude Code CLI（`npm install -g @anthropic-ai/claude-code`）
- tmux
- iTerm2（macOS）またはターミナル

. . .

**やり方:**

1. 配布セットをダウンロード
2. ARCHITECTURE.md を Claude に読ませる
3. 「自分のプロジェクトに合わせてエージェント構成を作ってくれ」と指示
4. `bash agents/launch.sh` で起動

. . .

::: {.callout-tip}
エージェントの役割・人数・キャラクターは自由にカスタマイズできます。
ARCHITECTURE.md の設計思想さえ理解すれば，あとは Claude が作ってくれます。
:::

## まとめ

- **生成AIのAgentモード**は「優秀な部下」。方針を定めて仕事を任せる
- **Claude Code CLI** + **tmux** で複数エージェントの同時稼働が可能
- CLI同士は直接通信できない → **ファイルベースの通信プロトコル**で解決
- **watcher.sh** がファイル変更を検知し，最小限のトリガーで連携
- 安全弁は**プロンプトによる行動制御** + **Gitブランチによる隔離**
- 設計思想（ARCHITECTURE.md）を配布すれば，各自の環境で再構築可能
